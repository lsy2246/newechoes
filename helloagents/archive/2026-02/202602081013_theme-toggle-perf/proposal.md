# 变更提案: theme-toggle-perf

## 元信息
```yaml
类型: 优化/重构
方案类型: implementation
优先级: P1
状态: 草稿
创建: 2026-02-08
```

---

## 1. 需求

### 背景
主题切换在偶发情况下出现卡顿与掉帧，影响“丝滑”体验。

### 目标
- 保持现有视觉与交互效果完全一致
- 降低切换时的主线程抖动与不必要的 DOM/样式重算
- 保持现有降级策略（View Transitions 不可用时正常切换）

### 约束条件
```yaml
时间约束: 无
性能约束: 切换过程无明显卡顿/掉帧
兼容性约束: 保持现有浏览器兼容策略
业务约束: 视觉与交互效果不变
```

### 验收标准
- [ ] 切换动画时长、波纹位置与扩散/收缩效果与现有一致
- [ ] 连续切换无明显卡顿/掉帧（主观观感）
- [ ] 无新增控制台错误或重复触发

---

## 2. 方案

### 技术方案
- 复用静态资源：预计算 maskSvg/maskUrl，避免每次切换重复 btoa 与字符串拼接。
- 复用临时样式节点：创建一次 style 元素，切换时仅更新内容与状态，减少 DOM 创建/移除。
- 复用波纹节点：保留单个 ripple 元素，更新位置并重启动画，减少 DOM churn。
- 初始化去重：增加全局初始化守卫，避免多实例组件导致重复监听器与重复逻辑执行。

### 影响范围
```yaml
涉及模块:
  - ThemeToggle: 事件绑定、动画与波纹逻辑优化
预计变更文件: 1
```

### 风险评估
| 风险 | 等级 | 应对 |
|------|------|------|
| 全局初始化守卫导致换页后未重绑 | 中 | cleanup 时重置全局标记，确保新页可再次初始化 |
| 动画细节变化 | 低 | 保持原有参数/时序，仅减少创建与重复计算 |
